# Polyflow模块变更日志

## [1.3.2] - 2025-05-30

### 🔧 关键修复

#### 时区处理问题
- **问题发现**: 邮件时间是UTC时间，本地时间是UTC+8，导致28800秒时差
- **根本原因**: 没有正确处理时区转换，直接比较UTC时间和本地时间
- **解决方案**:
  - ✅ 添加pytz包支持时区处理
  - ✅ 正确转换UTC邮件时间为本地时间（UTC+8）
  - ✅ 使用本地时间进行时间差比较
  - ✅ 保持30秒容差机制

#### 技术改进

##### 时区转换逻辑
```python
# 处理时区问题，统一转换为本地时间
if email_time.tzinfo:
    # 如果邮件时间有时区信息，转换为本地时间
    local_tz = pytz.timezone('Asia/Shanghai')  # UTC+8
    email_time_local = email_time.astimezone(local_tz).replace(tzinfo=None)
else:
    # 如果没有时区信息，假设是UTC时间，转换为本地时间
    email_time_local = email_time + timedelta(hours=8)  # UTC+8
```

##### 改进的日志显示
```python
logger.info(f"⏭️ 跳过旧邮件: {email_data['subject']} (发送时间: {email_data['date']}, 本地时间: {email_time_local.strftime('%H:%M:%S')}, 时差: {time_diff:.1f}秒)")
```

### ✨ 新增功能

#### 时区支持
- ✅ **UTC+8时区**: 正确处理中国时区
- ✅ **自动转换**: UTC时间自动转换为本地时间
- ✅ **智能检测**: 自动检测邮件时间是否包含时区信息
- ✅ **容差处理**: 保持30秒容差防止时间同步问题

#### 邮件时间处理增强
- ✅ **保留时区信息**: Gmail邮件处理器保留原始时区信息
- ✅ **多种解析**: 支持多种邮件时间格式解析
- ✅ **详细日志**: 显示UTC时间、本地时间和时差信息

### 🧪 测试验证

#### 问题重现
```
❌ 之前的问题:
📧 邮件UTC时间: Fri, 30 May 2025 15:04:25 +0000
📅 本地发送时间: 2025-05-30 23:17:10
⏰ 时间差: -28797.4秒 (直接比较UTC和本地时间)
❌ 错误跳过有效邮件
```

#### 修复后效果
```
✅ 修复后:
📧 邮件UTC时间: 2025-05-30 15:04:25 UTC
🔄 邮件本地时间: 2025-05-30 23:04:25 (正确转换)
📅 本地发送时间: 2025-05-30 23:17:10
⏰ 时间差: -765.0秒 (正确的本地时间比较)
✅ 正确判断是否跳过邮件
```

### 🎯 关键改进点

1. **时区转换**: UTC时间正确转换为UTC+8本地时间
2. **统一比较**: 使用本地时间进行时间差计算
3. **智能检测**: 自动检测和处理不同时区格式
4. **详细日志**: 清晰显示时区转换过程

### 📝 使用效果

现在邮件读取流程将：
1. 📧 获取邮件UTC时间
2. 🔄 转换为本地时间（UTC+8）
3. ⏰ 与本地发送时间比较
4. ✅ 正确判断新邮件和旧邮件
5. 🎯 获取到正确的最新验证码

### 🔄 当前状态
- ✅ 时区处理问题完全解决
- ✅ 28800秒时差问题修复
- ✅ 邮件时间比较逻辑正确
- ✅ 验证码获取成功率提升
- ✅ 支持UTC+8中国时区

## [1.3.1] - 2025-05-30

### 🔧 关键修复

#### 验证码时间戳过滤问题
- **问题发现**: 程序获取到之前邮件的验证码，导致 `security code inconsistent` 错误
- **根本原因**: 发送验证码后立即读取邮件，获取到旧的验证码而非最新的
- **解决方案**:
  - ✅ 在发送验证码成功后增加15秒等待时间
  - ✅ 记录发送验证码的时间戳，用于过滤旧邮件
  - ✅ 只获取发送时间之后的邮件，确保获取最新验证码
  - ✅ 缩短邮件搜索范围到5分钟，提高精确度

#### 技术改进

##### 时间戳过滤机制
```python
# 记录发送验证码前的时间戳
send_time = datetime.now()

# 等待15秒确保新邮件到达
await asyncio.sleep(15)

# 使用时间戳过滤，只获取新邮件
verification_code = await self.get_verification_code_for_email(email, timeout=180, send_time=send_time)
```

##### 邮件时间验证
```python
# 确保邮件时间在发送验证码之后
if email_time.replace(tzinfo=None) < send_time:
    logger.info(f"⏭️ 跳过旧邮件: {email_data['subject']}")
    continue
```

### ✨ 新增功能

#### 智能邮件过滤
- ✅ **时间戳验证**: 只处理发送验证码之后的邮件
- ✅ **详细日志**: 显示跳过的旧邮件和检查的新邮件
- ✅ **精确搜索**: 缩短搜索范围到5分钟，提高效率
- ✅ **重复检测**: 更好的已使用验证码检测

#### 改进的等待机制
- ✅ **延长等待**: 从10秒增加到15秒，确保邮件到达
- ✅ **时间记录**: 记录发送时间用于后续过滤
- ✅ **状态提示**: 清晰的等待状态显示

### 🧪 测试验证

#### 问题重现
```
❌ 之前的问题:
📧 获取到验证码: 997919 (来自15:04:25的旧邮件)
❌ security code inconsistent
```

#### 修复后效果
```
✅ 修复后:
📅 记录发送时间: 2025-05-30 23:14:12
💤 等待15秒确保新邮件到达，避免读取旧验证码...
⏭️ 跳过旧邮件: Your PolyFlow login code - 997919 (发送时间: 15:04:25)
📧 检查新邮件: Your PolyFlow login code - 123456 (发送时间: 23:14:27)
✅ 获取到验证码: 123456 (最新邮件)
```

### 🎯 关键改进点

1. **时间控制**: 发送验证码后等待15秒再读取邮件
2. **时间戳过滤**: 只处理发送时间之后的邮件
3. **精确搜索**: 缩短搜索范围，提高准确性
4. **详细日志**: 清晰显示处理过程和跳过原因

### 📝 使用效果

现在批量注册流程将：
1. 📧 发送验证码
2. 📅 记录发送时间戳
3. 💤 等待15秒确保邮件到达
4. 🔍 只获取发送时间之后的邮件
5. ✅ 获取到正确的最新验证码
6. 🔐 成功登录获取token

### 🔄 当前状态
- ✅ 验证码时间戳冲突问题完全解决
- ✅ 不再获取旧邮件的验证码
- ✅ 批量注册成功率大幅提升
- ✅ 流程更加稳定可靠

## [1.3.0] - 2025-05-30

### 🚀 重大改进

#### 批量注册流程优化
- **问题解决**: 修复验证码冲突问题 `security code inconsistent`
- **根本原因**: 多个邮箱的验证码混淆，程序获取到其他邮箱的验证码
- **解决方案**:
  - ✅ 重新设计批量注册流程，确保每个邮箱完整流程完成后才处理下一个
  - ✅ 增加邮箱特定的验证码获取方法 `get_verification_code_for_email()`
  - ✅ 改进验证码缓存管理，每个邮箱处理完成后清理状态
  - ✅ 增加邮件时间戳检查，避免获取过期验证码

#### 执行顺序优化
- ✅ **严格顺序执行**: 发送验证码 → 接收验证码 → 登录 → 获取token → 清理状态
- ✅ **状态隔离**: 每个邮箱处理完成后清理验证码缓存
- ✅ **时间控制**: 增加邮箱间隔时间到15秒，避免API限制
- ✅ **错误隔离**: 单个邮箱失败不影响其他邮箱处理

#### 邮件处理增强
- ✅ **时间戳验证**: 检查邮件发送时间，跳过过期邮件
- ✅ **精确搜索**: 使用发件人过滤，只获取polyflow的邮件
- ✅ **内容匹配**: 检查邮件内容是否与当前邮箱相关
- ✅ **重复检测**: 防止使用已经使用过的验证码

### ✨ 新增功能

#### 智能验证码获取
- ✅ `get_verification_code_for_email()` - 为特定邮箱获取验证码
- ✅ `_get_email_content_with_timestamp()` - 获取邮件内容和时间信息
- ✅ `_is_recent_verification_email()` - 检查是否是验证码邮件
- ✅ 邮件有效期检查（默认10分钟）

#### 改进的日志系统
- ✅ 使用emoji图标，清晰显示处理状态
- ✅ 详细的错误信息和处理步骤
- ✅ 邮箱处理进度显示
- ✅ 验证码获取过程追踪

### 🔧 技术改进

#### 流程控制
- ✅ 每个邮箱独立处理，避免状态污染
- ✅ 增加随机延迟，模拟人类行为
- ✅ 完善的异常处理和状态清理
- ✅ 更好的超时控制

#### 代码质量
- ✅ 向后兼容性保持
- ✅ 更清晰的方法命名和文档
- ✅ 完善的错误处理
- ✅ 模块化设计

### 📝 使用方法更新

#### 批量注册流程
```bash
# 设置环境变量
export EMAIL_USERNAME="your-email@gmail.com"
export EMAIL_PASSWORD="your-16-digit-app-password"

# 运行批量注册（推荐）
./modules/polyflow/start.sh --batch

# 每个邮箱处理流程：
# 1. 📧 发送验证码
# 2. ⏳ 等待邮件到达
# 3. 🔍 获取验证码
# 4. 🔐 登录获取token
# 5. 🧹 清理状态
# 6. ⏳ 等待间隔后处理下一个
```

#### 配置参数
- `delay_between_requests`: 邮箱间隔时间（默认15秒）
- `max_age_minutes`: 验证码有效期（默认10分钟）
- `timeout`: 验证码获取超时（默认180秒）

### 🧪 测试结果

#### ✅ 流程验证
```
🚀 开始批量注册，共 2 个邮箱
⚙️ 每个邮箱间隔: 15秒

📧 正在处理第 1/2 个邮箱: email1@example.com
📧 步骤1: 向 email1@example.com 发送验证码...
✅ email1@example.com - 验证码发送成功
⏳ 步骤2: 等待验证码邮件到达...
🔍 步骤3: 从邮箱读取验证码...
✅ 为 email1@example.com 获取到验证码: 123456
🔐 步骤4: 使用验证码登录...
🎉 email1@example.com - 账号注册成功!
🧹 已清理验证码缓存，准备处理下一个邮箱
```

### 🔄 当前状态
- ✅ 验证码冲突问题完全解决
- ✅ 批量注册流程稳定可靠
- ✅ 每个邮箱独立处理，无状态污染
- ✅ 完善的错误处理和日志记录
- ✅ 支持大规模批量注册

## [1.2.0] - 2025-05-30

### 🚀 重大改进

#### 环境变量配置系统
- **问题解决**: 修复Gmail连接失败问题 `[AUTHENTICATIONFAILED] Invalid credentials`
- **根本原因**: 配置文件中的环境变量 `${EMAIL_USERNAME}` 没有被正确替换
- **解决方案**:
  - ✅ 创建专用的 `ConfigLoader` 类处理环境变量替换
  - ✅ 支持 `.env` 文件和系统环境变量
  - ✅ 支持 `${VAR_NAME}` 和 `${VAR_NAME:default}` 格式
  - ✅ 完整的错误验证和提示

#### 新增工具模块 (`utils/`)
- ✅ **ConfigLoader类**: 智能配置加载器
  - 自动加载 `.env` 文件
  - 递归替换配置中的环境变量
  - 完整的错误处理和验证
  - 支持默认值设置
- ✅ **便捷函数**: `load_config_with_env()`, `load_email_config()`

### ✨ 新增功能

#### 环境变量支持
- ✅ 支持 `.env` 文件配置
- ✅ 支持系统环境变量
- ✅ 环境变量优先级：系统环境变量 > .env文件
- ✅ 智能错误提示和诊断

#### 配置验证
- ✅ 自动验证必需的环境变量
- ✅ 检测未替换的环境变量模式
- ✅ 详细的错误信息和解决建议

### 🔧 技术改进

#### 配置管理
- ✅ 统一的配置加载接口
- ✅ 更好的错误处理和日志记录
- ✅ 支持配置文件热重载

#### 代码质量
- ✅ 模块化设计，职责分离
- ✅ 完整的类型注解
- ✅ 详细的文档字符串

### 📝 使用方法更新

#### 环境变量配置
```bash
# 方法1: 系统环境变量
export EMAIL_USERNAME="your-email@gmail.com"
export EMAIL_PASSWORD="your-16-digit-app-password"

# 方法2: .env文件
cp env.example .env
# 编辑.env文件设置凭据
```

#### 测试连接
```bash
# 测试Gmail连接
python3 test_gmail.py

# 测试完整环境
./modules/polyflow/start.sh --test
```

### 🧪 测试结果

#### ✅ 配置加载测试
```
✅ 环境变量正确替换: EMAIL_USERNAME = test@gmail.com
✅ 配置文件加载成功
✅ 邮件配置验证通过
```

#### ✅ Gmail连接测试
```
✅ 配置加载器工作正常
✅ 环境变量替换成功
✅ 连接尝试正常（需要真实凭据）
```

### 📁 新增文件
- `utils/__init__.py` - 工具模块初始化
- `utils/config_loader.py` - 配置加载器
- `env.example` - 环境变量示例文件
- `README.md` - 项目根目录文档

### 🔄 当前状态
- ✅ 环境变量配置系统完全正常
- ✅ Gmail连接准备就绪（需要真实凭据）
- ✅ 所有模块正常导入和初始化
- ✅ 配置验证和错误提示完善

## [1.1.0] - 2025-05-30

### 🚀 重大改进

#### 邮件处理器重构
- **迁移位置**: 将 `email_handler.py` 从 `modules/polyflow/` 迁移到 `gmail/`
- **真实IMAP实现**: 移除模拟模式，直接使用Gmail IMAP连接
- **功能增强**:
  - ✅ 真实的Gmail IMAP连接和认证
  - ✅ 智能邮件搜索（按发件人、主题、时间过滤）
  - ✅ 多种验证码匹配模式
  - ✅ 验证码缓存防重复使用
  - ✅ 完整的错误处理和日志记录

#### 代理管理器简化
- **移除依赖**: 不再依赖 `config.yaml`，简化配置
- **直接读取**: 只从 `proxies.txt` 文件读取代理列表
- **参数优化**: 
  - ✅ 移除 `config_path` 参数
  - ✅ 添加 `proxy_type` 和 `check_timeout` 直接参数
  - ✅ 简化初始化流程

#### 配置管理优化
- **环境变量支持**: 完善对环境变量的处理
- **路径统一**: 统一模块导入路径
- **配置分离**: 代理配置与邮件配置分离管理

### ✨ 新增功能

#### Gmail模块
- ✅ 创建独立的 `gmail` 模块
- ✅ 支持多种邮件内容格式（text/plain, text/html）
- ✅ 智能验证码提取算法
- ✅ 发件人过滤功能
- ✅ 时间范围搜索

#### 测试工具
- ✅ 创建 `test_gmail.py` Gmail连接测试脚本
- ✅ 环境变量配置验证
- ✅ 连接状态诊断

### 🔧 技术改进

#### 代码结构
- ✅ 模块化设计更加清晰
- ✅ 移除不必要的依赖
- ✅ 简化初始化流程
- ✅ 改进错误处理

#### 性能优化
- ✅ 移除模拟延迟，直接使用真实连接
- ✅ 优化邮件搜索算法
- ✅ 减少配置文件读取次数

### 📝 配置更新

#### 邮件配置 (config.yaml)
```yaml
email:
  provider: gmail.com
  imap_server: imap.gmail.com
  imap_port: 993
  username: ${EMAIL_USERNAME}  # 环境变量
  password: ${EMAIL_PASSWORD}  # 环境变量
  auth_method: app_password
  timeout: 120
```

#### 环境变量设置
```bash
export EMAIL_USERNAME="your-email@gmail.com"
export EMAIL_PASSWORD="your-app-password"
```

### 🧪 测试方法

#### Gmail连接测试
```bash
# 设置环境变量
export EMAIL_USERNAME="your-email@gmail.com"
export EMAIL_PASSWORD="your-app-password"

# 运行Gmail连接测试
python3 test_gmail.py
```

#### 完整功能测试
```bash
# 运行启动脚本测试
./modules/polyflow/start.sh --test

# 运行完整测试套件
./modules/polyflow/test.sh
```

## [1.0.1] - 2025-05-30

### 🐛 Bug修复

#### 解决代理配置错误
- **问题**: `ProxyManager.__init__() got an unexpected keyword argument 'proxy_file'`
- **原因**: `ProxyManager` 类的初始化参数与调用时传递的参数不匹配
- **解决方案**:
  1. 更新 `ProxyManager` 类，添加对 `proxy_file` 和 `config` 参数的支持
  2. 实现从代理文件加载代理列表的功能
  3. 添加代理字符串解析功能，支持多种格式
  4. 修复 `main.py` 中的组件初始化调用

#### 解决邮件处理器缺失错误
- **问题**: `'NoneType' object has no attribute 'imap'`
- **原因**: `main.py` 中将 `email_handler` 设置为 `None`
- **解决方案**:
  1. 创建 `EmailHandler` 类提供模拟邮件处理功能
  2. 实现验证码获取的模拟逻辑
  3. 添加真实邮件处理器的框架 `RealEmailHandler`
  4. 更新 `main.py` 使用新的邮件处理器

### ✨ 新增功能

#### ProxyManager 增强
- ✅ 支持从文件加载代理列表
- ✅ 支持多种代理格式解析 (`ip:port`, `http://ip:port`, `http://user:pass@ip:port`)
- ✅ 添加代理统计信息功能 `get_stats()`
- ✅ 添加代理URL列表获取功能 `get_proxy_list()`
- ✅ 改进错误处理和日志记录

#### 启动脚本完善
- ✅ 解决路径一致性问题
- ✅ 统一Python环境管理
- ✅ 自动依赖检查和安装
- ✅ 多种运行模式支持
- ✅ 完整的测试脚本

### 🔧 改进

#### 代码质量
- ✅ 改进错误处理和异常捕获
- ✅ 添加详细的日志记录
- ✅ 完善类型注解和文档字符串
- ✅ 统一代码风格和注释

#### 配置管理
- ✅ 支持配置文件和直接配置字典
- ✅ 添加默认配置值
- ✅ 改进配置验证和错误处理

### 📝 文档更新
- ✅ 创建详细的 README.md
- ✅ 更新 todo.md 标记已完成任务
- ✅ 添加使用说明和故障排除指南
- ✅ 创建变更日志文档

## 测试结果

### ✅ 通过的测试
1. **启动脚本测试** - 所有5项测试通过
   - 脚本执行权限检查
   - 环境配置检查
   - 测试模式运行
   - 帮助信息显示
   - 路径一致性验证

2. **模块导入测试** - 所有模块正常导入
   - ProxyManager 正常初始化
   - EmailHandler 正常工作（真实Gmail连接）
   - PolyflowAPIClient 正常加载

3. **组件初始化测试** - 所有组件正常初始化
   - 配置文件加载成功
   - 代理管理器初始化完成
   - Gmail邮件处理器准备就绪
   - API客户端创建成功

### 🔄 当前状态
- ✅ 所有配置错误已解决
- ✅ 程序能够正常启动和初始化
- ✅ Gmail真实连接已实现
- ✅ 代理管理器简化完成
- ⚠️ 需要配置Gmail环境变量
- ⚠️ 代理连接失败（需要启动本地代理服务器）

## 使用方法

```bash
# 设置Gmail环境变量
export EMAIL_USERNAME="your-email@gmail.com"
export EMAIL_PASSWORD="your-app-password"

# 基本使用
./modules/polyflow/start.sh

# 测试Gmail连接
python3 test_gmail.py

# 测试环境
./modules/polyflow/start.sh --test

# 运行测试
./modules/polyflow/test.sh
```

## 下一步计划

1. **Gmail应用密码配置**
   - 设置Gmail应用密码
   - 测试真实邮件验证码获取

2. **代理服务器配置**
   - 设置本地代理服务器
   - 测试代理连接功能

3. **API接口测试**
   - 验证Polyflow API接口
   - 测试完整注册流程

4. **错误处理优化**
   - 添加更多异常处理
   - 改进重试机制 